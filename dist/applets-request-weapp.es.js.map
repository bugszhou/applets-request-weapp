{"version":3,"file":"applets-request-weapp.es.js","sources":["../src/helpers/utils.ts","../src/adapter/config.ts","../src/adapter/request.ts","../src/appletsRequestWeapp.ts"],"sourcesContent":["function getDataType(val: any): string {\n  return Object.prototype.toString.call(val);\n}\n\nexport function isPlainObject(val: any): val is Record<string, any> {\n  if (val === null || getDataType(val) !== \"[object Object]\") {\n    return false;\n  }\n  const prototype = Object.getPrototypeOf(val);\n  return prototype === null || prototype === Object.prototype;\n}\n\nexport function assign<T, U>(to: T, from: U): T & U {\n  if (isString(from)) {\n    return to as T & U;\n  }\n\n  for (const key in from) {\n    (to as T & U)[key] = from[key] as any;\n  }\n\n  return to as T & U;\n}\n\nexport function isUndefined(val: any): boolean {\n  return typeof val === \"undefined\";\n}\n\nexport function merge(\n  ...objs: Record<string, any>[]\n): any[] | Record<string, any> {\n  if (objs.length === 0) {\n    return Object.create(null);\n  }\n\n  let result: any = Object.create(null);\n  function assignValue(val: any, key: string | number): void {\n    if (isPlainObject(result[key]) && isPlainObject(val)) {\n      result[key] = merge(result[key], val);\n    } else if (isPlainObject(val)) {\n      result[key] = merge({}, val);\n    } else if (Array.isArray(val)) {\n      result[key] = merge(val);\n    } else {\n      result[key] = val;\n    }\n  }\n\n  if (Array.isArray(objs[0])) {\n    result = [];\n  } else {\n    result = Object.create(null);\n  }\n\n  objs.forEach((obj) => {\n    forEach(obj, assignValue);\n  });\n\n  return result;\n}\n\nexport function isString(val: any): boolean {\n  return typeof val === \"string\";\n}\n\n/**\n * 遍历\n * @param {Object|Array} obj\n * @param fn\n */\nexport function forEach(obj: any, fn: IAppletsRequest.IEmptyFN): void {\n  if (typeof obj === \"undefined\" || obj === null) {\n    return;\n  }\n\n  let arr = obj;\n\n  // 如果obj是非object类型，例如：number，string等\n  if (typeof obj !== \"object\") {\n    arr = [obj];\n  }\n\n  if (Array.isArray(arr)) {\n    arr.forEach((item, i) => {\n      fn.call(null, item, i, obj);\n    });\n    return;\n  }\n  Object.keys(arr).forEach((key) => {\n    fn.call(null, arr[key], key, arr);\n  });\n}\n","export default function getRequestOptions(\n  config: IAppletsRequest.IHttpConfig\n): IAppletsRequestWx.RequestOption {\n  const reqConfig: IAppletsRequestWx.RequestOption = {\n    url: config.url || \"\",\n    method: config.method,\n    data: config.data,\n    header: config.headers,\n    dataType: \"json\",\n    timeout: config.timeout,\n  } as IAppletsRequestWx.RequestOption;\n\n  const dataType = config.dataType || \"json\";\n  reqConfig.dataType = dataType;\n\n  if (config.responseType && config.responseType !== \"json\") {\n    reqConfig.dataType = \"其他\";\n  }\n\n  return reqConfig;\n}\n","/*\n * @Author: youzhao.zhou\n * @Date: 2021-02-04 16:09:10\n * @Last Modified by: youzhao.zhou\n * @Last Modified time: 2021-02-10 12:10:14\n * @Description request adapter\n *\n * 1. 执行成功需要返回IAppletsRequestResponse，执行失败即为reject返回IAppletsRequestAdapterError\n * 2. 如果取消返回IAppletsRequest.ICanceler\n */\n\nimport { isUndefined, merge } from \"../helpers/utils\";\nimport getRequestOptions from \"./config\";\n\ninterface IResolveOptions {\n  headers: Record<string, any>;\n  status: number;\n  data: any;\n  response?: any;\n}\n\nexport default function request(\n  config: IAppletsRequest.IHttpConfig\n): IAppletsRequestPromise {\n  function requestSuccess(res: any): IResolveOptions {\n    if (isUndefined(res) || res === null) {\n      return {\n        headers: {},\n        status: 200,\n        data: {},\n        response: res,\n      };\n    }\n\n    return {\n      headers: res.header,\n      status: res.statusCode,\n      data: dataParser(res.data),\n      response: res,\n    };\n  }\n\n  /**\n   * 获取错误类型\n   * @param err\n   * @param timeout\n   * @returns NETWORK_ERROR | TIMEOUT\n   * @example {\n   *    msg: `Timeout of 2000 ms exceeded`,\n   *    type: \"TIMEOUT\",\n   *  }\n   */\n  function failType(\n    err: any,\n    timeout: number | undefined\n  ): { msg: string; type: \"NETWORK_ERROR\" | \"TIMEOUT\" } {\n    if (\n      err &&\n      (err.errMsg || \"\").toString().toLowerCase().includes(\"timeout\")\n    ) {\n      return {\n        msg: `Timeout of ${timeout || \"\"} ms exceeded`,\n        type: \"TIMEOUT\",\n      };\n    }\n    return {\n      msg: `Network Error`,\n      type: \"NETWORK_ERROR\",\n    };\n  }\n\n  /**\n   * JSON parse data\n   * @param data\n   */\n  function dataParser(data: any): any {\n    if (typeof data !== \"string\") {\n      return data;\n    }\n    try {\n      return JSON.parse(data);\n    } catch (e) {\n      return data;\n    }\n  }\n\n  function getReqConfig(\n    originalConfig: IAppletsRequestWx.RequestOption\n  ): IAppletsRequest.IHttpConfig {\n    const tmpConfig: any = merge({}, originalConfig);\n    tmpConfig.headers = originalConfig.header;\n    delete tmpConfig.header;\n    delete tmpConfig.Adapter;\n    return tmpConfig;\n  }\n\n  return new Promise((resolve, reject) => {\n    const Adapter = config.Adapter;\n    const reqConfig = getRequestOptions(config);\n    const adapterConfig = getReqConfig(reqConfig);\n\n    if (!Adapter) {\n      throw new TypeError(\"Adapter is undefined or null\");\n    }\n\n    const adapter = new Adapter(adapterConfig);\n\n    let request = wx.request({\n      ...reqConfig,\n      success(res: any) {\n        adapter.resolve(requestSuccess(res), resolve);\n      },\n      fail(err: any) {\n        const errData = failType(err, reqConfig.timeout);\n        const rejectData = {\n          errMsg: errData.msg,\n          status: errData.type,\n          extra: err,\n        };\n\n        adapter.reject(rejectData, reject);\n      },\n      complete() {\n        request = null;\n      },\n    });\n\n    adapter.subscribeCancelEvent((reason) => {\n      reject(reason);\n      request.abort();\n      request = null;\n    });\n\n    if (typeof config.getRequestTask === \"function\") {\n      config.getRequestTask(request);\n    }\n  });\n}\n","import appletsRequest, { AppletsRequest } from \"applets-request\";\nimport weappAdapter from \"./adapter/request\";\n\nappletsRequest.defaults.adapter = weappAdapter;\n\nexport default appletsRequest;\n\nexport const defaults = appletsRequest.defaults;\n\nexport { AppletsRequest as AppletsRequest };\n"],"names":["weappAdapter"],"mappings":"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"}