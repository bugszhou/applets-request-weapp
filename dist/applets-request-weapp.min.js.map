{"version":3,"file":"applets-request-weapp.min.js","sources":["../src/helpers/utils.ts","../src/appletsRequestWeapp.ts","../src/adapter/request.ts","../src/adapter/config.ts"],"sourcesContent":["function getDataType(val: any): string {\n  return Object.prototype.toString.call(val);\n}\n\nexport function isPlainObject(val: any): val is Record<string, any> {\n  if (val === null || getDataType(val) !== \"[object Object]\") {\n    return false;\n  }\n  const prototype = Object.getPrototypeOf(val);\n  return prototype === null || prototype === Object.prototype;\n}\n\nexport function assign<T, U>(to: T, from: U): T & U {\n  if (isString(from)) {\n    return to as T & U;\n  }\n\n  for (const key in from) {\n    (to as T & U)[key] = from[key] as any;\n  }\n\n  return to as T & U;\n}\n\nexport function isUndefined(val: any): boolean {\n  return typeof val === \"undefined\";\n}\n\nexport function merge(\n  ...objs: Record<string, any>[]\n): any[] | Record<string, any> {\n  if (objs.length === 0) {\n    return Object.create(null);\n  }\n\n  let result: any = Object.create(null);\n  function assignValue(val: any, key: string | number): void {\n    if (isPlainObject(result[key]) && isPlainObject(val)) {\n      result[key] = merge(result[key], val);\n    } else if (isPlainObject(val)) {\n      result[key] = merge({}, val);\n    } else if (Array.isArray(val)) {\n      result[key] = merge(val);\n    } else {\n      result[key] = val;\n    }\n  }\n\n  if (Array.isArray(objs[0])) {\n    result = [];\n  } else {\n    result = Object.create(null);\n  }\n\n  objs.forEach((obj) => {\n    forEach(obj, assignValue);\n  });\n\n  return result;\n}\n\nexport function isString(val: any): boolean {\n  return typeof val === \"string\";\n}\n\n/**\n * 遍历\n * @param {Object|Array} obj\n * @param fn\n */\nexport function forEach(obj: any, fn: IAppletsRequest.IEmptyFN): void {\n  if (typeof obj === \"undefined\" || obj === null) {\n    return;\n  }\n\n  let arr = obj;\n\n  // 如果obj是非object类型，例如：number，string等\n  if (typeof obj !== \"object\") {\n    arr = [obj];\n  }\n\n  if (Array.isArray(arr)) {\n    arr.forEach((item, i) => {\n      fn.call(null, item, i, obj);\n    });\n    return;\n  }\n  Object.keys(arr).forEach((key) => {\n    fn.call(null, arr[key], key, arr);\n  });\n}\n","import appletsRequest, { AppletsRequest } from \"applets-request\";\nimport weappAdapter from \"./adapter/request\";\n\nappletsRequest.defaults.adapter = weappAdapter;\n\nexport default appletsRequest;\n\nexport const defaults = appletsRequest.defaults;\n\nexport { AppletsRequest as AppletsRequest };\n","/*\n * @Author: youzhao.zhou\n * @Date: 2021-02-04 16:09:10\n * @Last Modified by: youzhao.zhou\n * @Last Modified time: 2021-02-10 12:10:14\n * @Description request adapter\n *\n * 1. 执行成功需要返回IAppletsRequestResponse，执行失败即为reject返回IAppletsRequestAdapterError\n * 2. 如果取消返回IAppletsRequest.ICanceler\n */\n\nimport { isUndefined, merge } from \"../helpers/utils\";\nimport getRequestOptions from \"./config\";\n\ninterface IResolveOptions {\n  headers: Record<string, any>;\n  status: number;\n  data: any;\n  response?: any;\n}\n\nexport default function request(\n  config: IAppletsRequest.IHttpConfig\n): IAppletsRequestPromise {\n  function requestSuccess(res: any): IResolveOptions {\n    if (isUndefined(res) || res === null) {\n      return {\n        headers: {},\n        status: 200,\n        data: {},\n        response: res,\n      };\n    }\n\n    return {\n      headers: res.header,\n      status: res.statusCode,\n      data: dataParser(res.data),\n      response: res,\n    };\n  }\n\n  /**\n   * 获取错误类型\n   * @param err\n   * @param timeout\n   * @returns NETWORK_ERROR | TIMEOUT\n   * @example {\n   *    msg: `Timeout of 2000 ms exceeded`,\n   *    type: \"TIMEOUT\",\n   *  }\n   */\n  function failType(\n    err: any,\n    timeout: number | undefined\n  ): { msg: string; type: \"NETWORK_ERROR\" | \"TIMEOUT\" } {\n    if (\n      err &&\n      (err.errMsg || \"\").toString().toLowerCase().includes(\"timeout\")\n    ) {\n      return {\n        msg: `Timeout of ${timeout || \"\"} ms exceeded`,\n        type: \"TIMEOUT\",\n      };\n    }\n    return {\n      msg: `Network Error`,\n      type: \"NETWORK_ERROR\",\n    };\n  }\n\n  /**\n   * JSON parse data\n   * @param data\n   */\n  function dataParser(data: any): any {\n    if (typeof data !== \"string\") {\n      return data;\n    }\n    try {\n      return JSON.parse(data);\n    } catch (e) {\n      return data;\n    }\n  }\n\n  function getReqConfig(\n    originalConfig: IAppletsRequestWx.RequestOption\n  ): IAppletsRequest.IHttpConfig {\n    const tmpConfig: any = merge({}, originalConfig);\n    tmpConfig.headers = originalConfig.header;\n    delete tmpConfig.header;\n    delete tmpConfig.Adapter;\n    return tmpConfig;\n  }\n\n  return new Promise((resolve, reject) => {\n    const Adapter = config.Adapter;\n    const reqConfig = getRequestOptions(config);\n    const adapterConfig = getReqConfig(reqConfig);\n\n    if (!Adapter) {\n      throw new TypeError(\"Adapter is undefined or null\");\n    }\n\n    const adapter = new Adapter(adapterConfig);\n\n    let request = wx.request({\n      ...reqConfig,\n      success(res: any) {\n        adapter.resolve(requestSuccess(res), resolve);\n      },\n      fail(err: any) {\n        const errData = failType(err, reqConfig.timeout);\n        const rejectData = {\n          errMsg: errData.msg,\n          status: errData.type,\n          extra: err,\n        };\n\n        adapter.reject(rejectData, reject);\n      },\n      complete() {\n        request = null;\n      },\n    });\n\n    adapter.subscribeCancelEvent((reason) => {\n      reject(reason);\n      request.abort();\n      request = null;\n    });\n\n    if (typeof config.getRequestTask === \"function\") {\n      config.getRequestTask(request);\n    }\n  });\n}\n","export default function getRequestOptions(\n  config: IAppletsRequest.IHttpConfig\n): IAppletsRequestWx.RequestOption {\n  const reqConfig: IAppletsRequestWx.RequestOption = {\n    url: config.url || \"\",\n    method: config.method,\n    data: config.data,\n    header: config.headers,\n    dataType: \"json\",\n    timeout: config.timeout,\n  } as IAppletsRequestWx.RequestOption;\n\n  const dataType = config.dataType || \"json\";\n  reqConfig.dataType = dataType;\n\n  if (config.responseType && config.responseType !== \"json\") {\n    reqConfig.dataType = \"其他\";\n  }\n\n  return reqConfig;\n}\n"],"names":["isPlainObject","val","Object","prototype","toString","call","getDataType","getPrototypeOf","merge","_i","objs","length","create","result","assignValue","key","Array","isArray","forEach","obj","fn","arr","item","i","keys","appletsRequest","defaults","adapter","config","dataParser","data","JSON","parse","e","getReqConfig","originalConfig","tmpConfig","headers","header","Adapter","Promise","resolve","reject","reqConfig","url","method","dataType","timeout","responseType","getRequestOptions","adapterConfig","TypeError","request","wx","success","res","isUndefined","status","response","statusCode","requestSuccess","fail","err","errData","errMsg","toLowerCase","includes","msg","type","failType","rejectData","extra","complete","subscribeCancelEvent","reason","abort","getRequestTask"],"mappings":"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"}